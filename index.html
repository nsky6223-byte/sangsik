<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì–‘ í€´ì¦ˆ ì•±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5484135271892898"
     crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f1f5f9; /* slate-100 */
            --text-color: #1e293b; /* slate-800 */
            --card-bg-color: #ffffff;
            --subtext-color: #64748b; /* slate-500 */
            --border-color: #e2e8f0; /* slate-200 */
            --button-text-color: #334155; /* slate-700 */
        }
        html.dark {
            --bg-color: #0f172a; /* slate-900 */
            --text-color: #f1f5f9; /* slate-100 */
            --card-bg-color: #1e293b; /* slate-800 */
            --subtext-color: #94a3b8; /* slate-400 */
            --border-color: #334155; /* slate-700 */
            --button-text-color: #cbd5e1; /* slate-300 */
        }
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .card { background-color: var(--card-bg-color); }
        .subtext { color: var(--subtext-color); }
        .border-custom { border-color: var(--border-color); }
        .button-custom { color: var(--button-text-color); }

        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .option-btn.correct { background-color: #22c55e; color: white; border-color: #16a34a; }
        .option-btn.incorrect { background-color: #ef4444; color: white; border-color: #dc2626; }
        .pet-bounce { animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-15px); } 60% { transform: translateY(-7px); } }
        .speech-bubble { position: relative; background: var(--bg-color); border-radius: .4em; }
        .speech-bubble:after { content: ''; position: absolute; left: 0; top: 50%; width: 0; height: 0; border: 20px solid transparent; border-right-color: var(--bg-color); border-left: 0; border-bottom: 0; margin-top: -10px; margin-left: -20px; }
    </style>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5484135271892898"
     crossorigin="anonymous"></script>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- ë°°ê²½ìŒì•… í”Œë ˆì´ì–´: audio/background.mp3 íŒŒì¼ì„ í´ë”ì— ì¶”ê°€í•´ì£¼ì„¸ìš”. -->
    <audio id="bgm" loop src="audio/background.mp3"></audio>

    <div id="loading-spinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div></div>

    <!-- 1. ë©”ì¸ í™”ë©´ -->
    <div id="main-screen" class="w-full max-w-md mx-auto text-center">
        <div class="mb-8 p-4 card rounded-2xl shadow-md">
            <div id="pet-display" class="text-6xl pet-bounce">ğŸ±</div>
            <div id="pet-name" class="font-bold mt-2">ë‚˜ë¹„</div>
            <div id="streak-display" class="mt-4 text-orange-500 font-bold text-lg">ğŸ”¥ 0ì¼ ì—°ì† ì¶œì„!</div>
        </div>
        <header class="mb-8">
            <h1 class="text-5xl font-bold tracking-tight">ìƒì‹ í€´ì¦ˆ ì•±</h1>
            <p class="subtext mt-2">ë§¤ì¼ë§¤ì¼ ì„±ì¥í•˜ëŠ” ì§€ì‹ì˜ ì¦ê±°ì›€</p>
        </header>
        <main class="space-y-4">
            <button id="daily-quiz-btn" class="main-btn w-full bg-green-500 text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-green-600">ì˜¤ëŠ˜ì˜ í€´ì¦ˆ âœ¨</button>
            <!-- íƒ€ì„ì–´íƒ ë²„íŠ¼ ì¶”ê°€ -->
            <button id="time-attack-btn" class="main-btn w-full bg-orange-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-orange-600">íƒ€ì„ì–´íƒ â±ï¸</button>
            <button id="theme-select-btn" class="main-btn w-full bg-blue-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-600">í…Œë§ˆ í€´ì¦ˆ</button>
            <button id="pet-select-btn" class="main-btn w-full card button-custom font-bold py-3 px-6 rounded-lg shadow-md hover:bg-slate-200">í« ì„ íƒ</button>
            <button id="notes-btn" class="main-btn w-full card button-custom font-bold py-3 px-6 rounded-lg shadow-md hover:bg-slate-200">ì˜¤ë‹µë…¸íŠ¸</button>
            <button id="settings-btn" class="main-btn w-full card button-custom font-bold py-3 px-6 rounded-lg shadow-md hover:bg-slate-200">ì„¤ì •</button>
        </main>
    </div>

    <!-- 2. í€´ì¦ˆ ì§„í–‰ í™”ë©´ -->
    <div id="quiz-screen" class="card rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-2xl hidden">
        <div class="flex items-center mb-4">
            <button id="home-btn" class="text-slate-400 hover:text-slate-600 mr-4 p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg></button>
            <!-- íƒ€ì„ì–´íƒ íƒ€ì´ë¨¸ ë””ìŠ¤í”Œë ˆì´ ì¶”ê°€ -->
            <div id="timer-display" class="text-2xl font-bold text-red-500 hidden">01:00</div>
            <div id="progress-container" class="w-full">
                <div class="flex justify-between items-center mb-1"><span id="quiz-theme-title" class="text-base font-medium text-blue-500"></span><span id="progress-text" class="text-sm font-medium text-blue-500"></span></div>
                <div class="w-full bg-gray-200 rounded-full h-2.5"><div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div></div>
            </div>
        </div>
        <div id="quiz-container"><h2 id="question" class="text-2xl md:text-3xl font-bold my-6 min-h-[100px]"></h2><div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div></div>
        <div id="result-container" class="text-center hidden">
            <h2 id="result-title" class="text-4xl font-bold my-6">í€´ì¦ˆ ì™„ë£Œ!</h2>
            <p id="result-message" class="text-xl subtext mb-8">ì´ <span id="total-questions" class="font-bold">0</span>ë¬¸ì œ ì¤‘ <span id="score" class="font-bold text-blue-500">0</span>ê°œë¥¼ ë§íˆì…¨ìŠµë‹ˆë‹¤!</p>
            <button id="restart-btn" class="bg-blue-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-blue-600">ë‹¤ì‹œ í’€ê¸°</button>
            <!-- íƒ€ì„ì–´íƒ í•´ì„¤ ë³´ê¸° ë²„íŠ¼ ì¶”ê°€ -->
            <button id="review-explanations-btn" class="bg-purple-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-purple-600 mt-4 hidden">í•´ì„¤ ë³´ê¸°</button>
        </div>
    </div>

    <!-- 3. í”¼ë“œë°± ëª¨ë‹¬ -->
    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 fade-in">
        <div class="card rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="flex items-center"><div id="feedback-pet-icon" class="text-6xl mr-6">ğŸ±</div><div class="speech-bubble p-4 flex-1"><p id="feedback-message" class="font-bold text-lg"></p></div></div>
            <div id="explanation-container" class="mt-6 p-4 rounded-lg border border-custom">
                <h3 class="font-bold text-lg mb-2">í•´ì„¤</h3><p id="explanation-text" class="subtext"></p>
            </div>
            <div class="mt-8 text-right"><button id="next-btn" class="bg-blue-500 text-white font-bold py-2 px-8 rounded-lg hover:bg-blue-600">ë‹¤ìŒ</button></div>
        </div>
    </div>

    <!-- 4. ê¸°íƒ€ ëª¨ë‹¬ ì°½ë“¤ -->
    <div id="theme-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 fade-in"><div class="card rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center"><h2 class="text-2xl font-bold mb-6">í…Œë§ˆ ì„ íƒ</h2><div class="space-y-3 max-h-80 overflow-y-auto"><button data-theme="art" class="theme-btn w-full bg-amber-400 text-white py-3 rounded-lg hover:bg-amber-500">ë¯¸ìˆ  ğŸ¨</button><button data-theme="history" class="theme-btn w-full bg-teal-500 text-white py-3 rounded-lg hover:bg-teal-600">ì„¸ê³„ì‚¬ ğŸŒ</button><button data-theme="korean" class="theme-btn w-full bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600">ìš°ë¦¬ë§ ê²¨ë£¨ê¸° ğŸ‡°ğŸ‡·</button><button data-theme="capitals" class="theme-btn w-full bg-indigo-500 text-white py-3 rounded-lg hover:bg-indigo-600">ì„¸ê³„ ìˆ˜ë„ ë§íˆê¸° ğŸ—ºï¸</button><button data-theme="idioms" class="theme-btn w-full bg-red-500 text-white py-3 rounded-lg hover:bg-red-600">ì‚¬ìì„±ì–´ ğŸ“–</button><button data-theme="proverbs" class="theme-btn w-full bg-lime-500 text-white py-3 rounded-lg hover:bg-lime-600">ì†ë‹´ ë¹ˆì¹¸ âœï¸</button></div><button class="modal-close-btn mt-8 bg-slate-200 button-custom py-2 px-6 rounded-lg hover:bg-slate-300">ë‹«ê¸°</button></div></div>
    <div id="notes-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 fade-in"><div class="card rounded-2xl shadow-2xl p-8 w-full max-w-md"><h2 class="text-2xl font-bold mb-4 text-center">ì˜¤ë‹µë…¸íŠ¸</h2><div id="notes-content" class="subtext mb-6 max-h-80 overflow-y-auto p-1"></div><div class="flex justify-center space-x-4"><button id="retry-notes-btn" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed">ë‹¤ì‹œ ë„ì „!</button><button class="modal-close-btn bg-slate-200 button-custom py-2 px-6 rounded-lg hover:bg-slate-300">ë‹«ê¸°</button></div></div></div>
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 fade-in">
    <div class="card rounded-2xl shadow-2xl p-8 w-full max-w-sm">
        <h2 class="text-2xl font-bold mb-6 text-center">ì„¤ì •</h2>
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <span class="font-medium">ë‹¤í¬ ëª¨ë“œ</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="dark-mode-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
            <div>
                <span class="font-medium">ê¸€ì í¬ê¸°</span>
                <div id="font-size-controls" class="flex justify-between mt-2 rounded-lg bg-sky-100 dark:bg-slate-700 p-1">
                    <button data-size="sm" class="w-full rounded-md py-1">ì‘ê²Œ</button>
                    <button data-size="base" class="w-full rounded-md py-1">ë³´í†µ</button>
                    <button data-size="lg" class="w-full rounded-md py-1">í¬ê²Œ</button>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <span class="font-medium">ë°°ê²½ìŒì•…</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="bgm-toggle" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
            <div class="flex items-center justify-between">
                <span class="font-medium">íš¨ê³¼ìŒ</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="sound-toggle" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
        </div>
        <div class="text-center">
            <button class="modal-close-btn mt-8 bg-slate-200 button-custom py-2 px-6 rounded-lg hover:bg-slate-300">ë‹«ê¸°</button>
            <!-- ê°œë°œì ì»¤í”¼ ì‚¬ì£¼ê¸° ë²„íŠ¼ (ì„ì‹œ ë¹„í™œì„±í™”)
            <div class="text-center">
                <button id="coffee-btn" class="mt-4 bg-yellow-400 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-500 flex items-center justify-center mx-auto">
                    â˜• ê°œë°œì ì»¤í”¼ ì‚¬ì£¼ê¸°
                </button>
            </div>
            -->
        </div>
    </div>
</div>
    <div id="pet-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 fade-in">
        <div class="card rounded-2xl shadow-2xl p-8 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6 text-center">í•¨ê»˜í•  í«ì„ ì„ íƒí•˜ì„¸ìš”!</h2>
            <div id="pet-selection-container" class="space-y-4 max-h-80 overflow-y-auto"></div>
            <div class="text-center">
                <button class="modal-close-btn mt-8 bg-slate-200 button-custom py-2 px-6 rounded-lg hover:bg-slate-300">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- 5. ì±•í„° ì„ íƒ ëª¨ë‹¬ -->
    <div id="chapter-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 fade-in">
        <div class="card rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-6">ì±•í„° ì„ íƒ</h2>
            <div id="chapter-list" class="space-y-3 max-h-80 overflow-y-auto"></div>
            <button class="modal-close-btn mt-8 bg-slate-200 button-custom py-2 px-6 rounded-lg hover:bg-slate-300">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        const quizInfo = {
    art: { title: "ë¯¸ìˆ  ğŸ¨", file: "data/art.json" },
    history: { title: "ì„¸ê³„ì‚¬ ğŸŒ", file: "data/history.json" },
    korean: { title: "ìš°ë¦¬ë§ ê²¨ë£¨ê¸° ğŸ‡°ğŸ‡·", file: "data/korean.json" },
    capitals: { title: "ì„¸ê³„ ìˆ˜ë„ ë§íˆê¸° ğŸ—ºï¸", file: "data/capitals.json" },
    idioms: { title: "ì‚¬ìì„±ì–´ ğŸ“–", file: "data/idioms.json" },
    proverbs: { title: "ì†ë‹´ ë¹ˆì¹¸ âœï¸", file: "data/proverbs.json" }
};

        const petInfo = {
            cat: { name: 'ë‚˜ë¹„', icon: 'ğŸ±', description: 'ì‹œí¬í•˜ì§€ë§Œ ë‹¤ì •í•œ ì¸¤ë°ë ˆ.', correct: ["í¥, ì´ ì •ë„ëŠ” ë‹¹ì—°í•˜ì–ì•„?", "ì œë²•ì´ë„¤.", "ë‚˜ì˜ì§€ ì•Šêµ°."], incorrect: ["...ë‹¤ìŒì—” ì˜ í•˜ë“ ê°€.", "ì§‘ì¤‘ ì•ˆ í•´?", "ì¯§..."] },
            dog: { name: 'ë©ë­‰ì´', icon: 'ğŸ¶', description: 'í™œë°œí•˜ê³  ê¸ì •ì ì¸ ì‘ì›ë‹¨ì¥.', correct: ["ì™€! ìµœê³ ! ìµœê³ !", "ìš°ë¦¬ ì£¼ì¸ë‹˜ ì²œì¬!", "ì •ë‹µ! ì‹ ë‚œë‹¤! ë©ë©!"], incorrect: ["ê´œì°®ì•„! ë‚´ê°€ ìˆì–ì•„!", "í˜ë‚´! í•  ìˆ˜ ìˆì–´!", "í•˜ë‚˜ í‹€ë ¤ë„ ê´œì°®ì•„!"] },
            owl: { name: 'ë¶€ì—‰ë°•ì‚¬', icon: 'ğŸ¦‰', description: 'ì§€ì ì´ê³  ë¶„ì„ì ì¸ ì¡°ì–¸ê°€.', correct: ["í›Œë¥­í•œ ì¶”ë¡ ì…ë‹ˆë‹¤.", "ì§€ì‹ì´ +1 ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤.", "ì •í™•í•œ ë¶„ì„ì…ë‹ˆë‹¤."], incorrect: ["ì˜¤ë‹µì˜ ì›ì¸ì„ ë¶„ì„í•´ ë´…ì‹œë‹¤.", "ì´ ë¶€ë¶„ì€ ë‹¤ì‹œ í•™ìŠµí•  í•„ìš”ê°€ ìˆê² êµ°ìš”.", "ë‹¤ë¥¸ ê°€ëŠ¥ì„±ì„ ê³ ë ¤í•´ë³´ì‹œì£ ."] }
        };

        const clickSound = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
        const correctSound = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();
        const incorrectSound = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();

        let isBgmInitialized = false;

        function manageBgm() {
            const bgm = document.getElementById('bgm');
            if (!bgm) return;
            if (gameState.settings.bgmEnabled) {
                const playPromise = bgm.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log("BGM ìë™ ì¬ìƒì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìš©ì í´ë¦­ í›„ ì¬ìƒë©ë‹ˆë‹¤.");
                    });
                }
            } else {
                bgm.pause();
            }
        }

        let gameState = {
            streak: 0,
            lastVisit: null,
            settings: { darkMode: false, fontSize: "base", soundEnabled: true, bgmEnabled: true, selectedPet: "cat" },
            dailyQuiz: { date: null, questions: [] }
        };
        
        let allQuizzes = [];
        let timeAttackTimer;
        let timeLeft = 60;
        let timeAttackSolvedQuizzes = [];
        let isTimeAttackMode = false;
        let reviewIndex = 0;

        let incorrectQuizzes = [], currentQuizData = [], currentQuizIndex = 0, score = 0, answerSelected = false, isReviewMode = false;

        const mainScreen = document.getElementById('main-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const feedbackModal = document.getElementById('feedback-modal');
        const loadingSpinner = document.getElementById('loading-spinner');
        const questionEl = document.getElementById('question');
        const optionsContainer = document.getElementById('options-container');
        const explanationContainer = document.getElementById('explanation-container');
        const explanationTextEl = document.getElementById('explanation-text');
        const nextBtn = document.getElementById('next-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const resultContainer = document.getElementById('result-container');
        const scoreEl = document.getElementById('score');
        const totalQuestionsEl = document.getElementById('total-questions');
        const restartBtn = document.getElementById('restart-btn');
        const homeBtn = document.getElementById('home-btn');
        const quizThemeTitle = document.getElementById('quiz-theme-title');
        const notesContent = document.getElementById('notes-content');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const feedbackPetIcon = document.getElementById('feedback-pet-icon');

        // íƒ€ì„ì–´íƒ UI ìš”ì†Œ
        const timerDisplay = document.getElementById('timer-display');
        const progressContainer = document.getElementById('progress-container');
        const reviewExplanationsBtn = document.getElementById('review-explanations-btn');
        const resultTitle = document.getElementById('result-title');
        const resultMessage = document.getElementById('result-message');
        

        function saveGameState() { localStorage.setItem('quizGameState', JSON.stringify(gameState)); }

        function loadGameState() {
            const savedState = localStorage.getItem('quizGameState');
            if (savedState) {
                try {
                    const parsedState = JSON.parse(savedState);
                    gameState.streak = parsedState.streak || 0;
                    gameState.lastVisit = parsedState.lastVisit || null;
                    if (parsedState.settings) gameState.settings = { ...gameState.settings, ...parsedState.settings };
                    if (parsedState.dailyQuiz) gameState.dailyQuiz = { ...gameState.dailyQuiz, ...parsedState.dailyQuiz };
                } catch (e) {
                    console.error("ì €ì¥ëœ ê²Œì„ ìƒíƒœë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", e);
                    localStorage.removeItem('quizGameState');
                }
            }
        }

        function applySettings() {
            document.documentElement.classList.toggle('dark', gameState.settings.darkMode);
            document.body.classList.remove('text-sm', 'text-base', 'text-lg');
            document.body.classList.add(`text-${gameState.settings.fontSize}`);
            
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            if(darkModeToggle) darkModeToggle.checked = gameState.settings.darkMode;

            const soundToggle = document.getElementById('sound-toggle');
            if(soundToggle) soundToggle.checked = gameState.settings.soundEnabled;

            const bgmToggle = document.getElementById('bgm-toggle');
            if(bgmToggle) bgmToggle.checked = gameState.settings.bgmEnabled;

            const fontSizeControls = document.getElementById('font-size-controls');
            if(fontSizeControls) {
                [...fontSizeControls.children].forEach(btn => {
                    btn.classList.toggle('bg-blue-500', btn.dataset.size === gameState.settings.fontSize);
                    btn.classList.toggle('text-white', btn.dataset.size === gameState.settings.fontSize);
                });
            }
        }

        function updateMainUI() {
            document.getElementById('streak-display').innerText = `ğŸ”¥ ${gameState.streak}ì¼ ì—°ì† ì¶œì„!`;
            const currentPet = petInfo[gameState.settings.selectedPet] || petInfo.cat;
            document.getElementById('pet-display').innerText = currentPet.icon;
            document.getElementById('pet-name').innerText = currentPet.name;
        }

        function checkAttendance() {
            const today = new Date().toDateString();
            if (gameState.lastVisit !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (gameState.lastVisit === yesterday.toDateString()) gameState.streak++;
                else gameState.streak = 1;
                gameState.lastVisit = today;
                saveGameState();
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function showScreen(screenId) {
            mainScreen.classList.add('hidden');
            quizScreen.classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
        }

        async function startQuiz(themeKey, customData = null) {
            loadingSpinner.classList.remove('hidden');
            isReviewMode = customData !== null;
            isTimeAttackMode = false; // ì¼ë°˜ í€´ì¦ˆ ëª¨ë“œ í”Œë˜ê·¸
            try {
                let data;
                if (isReviewMode) {
                    data = customData;
                    quizThemeTitle.innerText = "ì˜¤ë‹µ ë³µìŠµ í€´ì¦ˆ ğŸ§";
                    quizThemeTitle.dataset.themeKey = 'review';
                } else if (themeKey === 'daily') {
                    data = await getDailyQuiz();
                    if (data.length === 0) { 
                        loadingSpinner.classList.add('hidden');
                        return;
                    }
                    quizThemeTitle.innerText = "ì˜¤ëŠ˜ì˜ í€´ì¦ˆ âœ¨";
                    quizThemeTitle.dataset.themeKey = 'daily';
                } else {
                    const response = await fetch(quizInfo[themeKey].file);
                    if (!response.ok && window.location.protocol !== 'file:') { 
                        throw new Error(`ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. Status: ${response.status}`);
                    }
                    data = await response.json();
                    quizThemeTitle.innerText = quizInfo[themeKey].title;
                    quizThemeTitle.dataset.themeKey = themeKey;
                }
                
                currentQuizData = shuffleArray(data);
                currentQuizIndex = 0;
                score = 0;

                // UI ì´ˆê¸°í™”
                progressContainer.classList.remove('hidden');
                timerDisplay.classList.add('hidden');
                
                loadQuiz();
                showScreen('quiz-screen');
                resultContainer.classList.add('hidden');
                quizContainer.classList.remove('hidden');
            } catch (error) {
                console.error("í€´ì¦ˆ ì‹œì‘ ì˜¤ë¥˜:", error);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }
        
        // ëª¨ë“  í€´ì¦ˆë¥¼ í•œ ë²ˆì— í‰íƒ„í™”í•´ì„œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
async function getAllFlatQuizzes() {
    const quizPromises = Object.values(quizInfo).map(info =>
        fetch(info.file)
            .then(res => {
                if (!res.ok && window.location.protocol !== 'file:') {
                    console.error(`'${info.file}' íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Status: ${res.status}`);
                    return []; // ì‹¤íŒ¨ ì‹œ ë¹ˆ ë°°ì—´ ë°˜í™˜
                }
                return res.json();
            })
            .catch(error => {
                console.error(`'${info.file}' íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:`, error);
                return []; // íŒŒì‹± ì˜¤ë¥˜ ë“± ë°œìƒ ì‹œ ë¹ˆ ë°°ì—´ ë°˜í™˜
            })
    );

    const allQuizData = await Promise.all(quizPromises);
    // ì±•í„° êµ¬ì¡°ì—ì„œ ëª¨ë“  ë¬¸ì œë¥¼ í‰íƒ„í™”
    return allQuizData.flatMap(themeArr =>
        Array.isArray(themeArr)
            ? themeArr.flatMap(ch => Array.isArray(ch.quizzes) ? ch.quizzes : [])
            : []
    );
}

// ì˜¤ëŠ˜ì˜ í€´ì¦ˆ: ëª¨ë“  ë¬¸ì œ ì¤‘ ëœë¤ 10ë¬¸ì œ
async function startDailyQuiz() {
    loadingSpinner.classList.remove('hidden');
    isTimeAttackMode = false;
    try {
        // ìš°ë¦¬ ì„œë²„ì˜ API ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
        const response = await fetch('/api/daily-quiz');
        const newQuizzes = await response.json();

        currentQuizData = newQuizzes;
        currentQuizIndex = 0;
        score = 0;
        quizThemeTitle.innerText = "ì˜¤ëŠ˜ì˜ í€´ì¦ˆ âœ¨";
        quizThemeTitle.dataset.themeKey = "daily";
        progressContainer.classList.remove('hidden');
        timerDisplay.classList.add('hidden');
        loadQuiz();
        showScreen('quiz-screen');
        resultContainer.classList.add('hidden');
        
    } catch (error) {
        console.error("ì˜¤ëŠ˜ì˜ í€´ì¦ˆ ë¡œë”© ì‹¤íŒ¨:", error);
        alert("AI í€´ì¦ˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    } finally {
        loadingSpinner.classList.add('hidden');
    }
}

        function loadQuiz() {
            answerSelected = false;
            const currentQuiz = currentQuizData[currentQuizIndex];
            if (!currentQuiz) { // íƒ€ì„ì–´íƒ ì¤‘ ë¬¸ì œê°€ ë‹¤ ë–¨ì–´ì¡Œì„ ê²½ìš°
                if(isTimeAttackMode) endTimeAttack();
                return;
            }
            questionEl.innerText = currentQuiz.question;
            optionsContainer.innerHTML = "";
            const shuffledOptions = shuffleArray([...currentQuiz.options]);
            shuffledOptions.forEach(optionText => {
                const button = document.createElement('button');
                button.innerText = optionText;
                button.classList.add('option-btn', 'w-full', 'p-4', 'border', 'border-custom', 'rounded-lg', 'text-left', 'transition', 'hover:bg-slate-200', 'dark:hover:bg-slate-700');
                button.addEventListener('click', () => selectAnswer(button, optionText));
                optionsContainer.appendChild(button);
            });
            if (!isTimeAttackMode) {
                progressText.innerText = `${currentQuizIndex + 1} / ${currentQuizData.length}`;
                progressBar.style.width = `${((currentQuizIndex + 1) / currentQuizData.length) * 100}%`;
            }
        }

        function selectAnswer(button, selectedOption) {
            if (answerSelected) return;
            
            const currentQuiz = currentQuizData[currentQuizIndex];
            const isCorrect = selectedOption === currentQuiz.answer;

            if (isTimeAttackMode) {
                if (isCorrect) {
                    answerSelected = true;
                    score++;
                    if(gameState.settings.soundEnabled) correctSound.triggerAttackRelease("C5", "0.2");
                    button.classList.add('correct');
                    timeAttackSolvedQuizzes.push(currentQuiz);
                    
                    setTimeout(() => {
                        currentQuizIndex++;
                        loadQuiz();
                    }, 200); // ì •ë‹µ ì‹œ ì ê¹ ì´ˆë¡ë¶ˆ ë³´ì—¬ì£¼ê³  ë„˜ì–´ê°
                } else {
                    if(gameState.settings.soundEnabled) incorrectSound.triggerAttackRelease("C3", "0.2");
                    button.classList.add('incorrect');
                    button.disabled = true; // í‹€ë¦° ë²„íŠ¼ ë¹„í™œì„±í™”
                    
                    // 2ì´ˆ íŒ¨ë„í‹°
                    optionsContainer.classList.add('pointer-events-none');
                    setTimeout(() => {
                        button.classList.remove('incorrect');
                        button.disabled = false;
                        optionsContainer.classList.remove('pointer-events-none');
                    }, 2000); // 2ì´ˆ íŒ¨ë„í‹°ë¡œ ë³€ê²½
                }
                return;
            }

            // --- ì´í•˜ ì¼ë°˜ í€´ì¦ˆ ëª¨ë“œ ë¡œì§ ---
            answerSelected = true;
            const currentPet = petInfo[gameState.settings.selectedPet] || petInfo.cat;
            let feedbackMessage;

            explanationContainer.classList.remove('bg-green-100', 'dark:bg-green-900', 'bg-red-100', 'dark:bg-red-900');

            if (isCorrect) {
                score++;
                button.classList.add('correct');
                if(gameState.settings.soundEnabled) correctSound.triggerAttackRelease("C5", "0.2");
                feedbackMessage = currentPet.correct[Math.floor(Math.random() * currentPet.correct.length)];
                explanationContainer.classList.add('bg-green-100', 'dark:bg-green-900');
                if (isReviewMode) {
                    const originalIndex = incorrectQuizzes.findIndex(q => q.question === currentQuiz.question);
                    if (originalIndex > -1) {
                        incorrectQuizzes.splice(originalIndex, 1);
                    }
                }
            } else {
                button.classList.add('incorrect');
                if(gameState.settings.soundEnabled) incorrectSound.triggerAttackRelease("C3", "0.2");
                if (!isReviewMode && !incorrectQuizzes.some(q => q.question === currentQuiz.question)) {
                    incorrectQuizzes.push(currentQuiz);
                }
                Array.from(optionsContainer.children).forEach(btn => {
                    if (btn.innerText === currentQuiz.answer) btn.classList.add('correct');
                });
                feedbackMessage = currentPet.incorrect[Math.floor(Math.random() * currentPet.incorrect.length)];
                explanationContainer.classList.add('bg-red-100', 'dark:bg-red-900');
            }

            Array.from(optionsContainer.children).forEach(btn => {
                btn.disabled = true;
                btn.classList.add('cursor-not-allowed');
            });

            feedbackPetIcon.innerText = currentPet.icon;
            feedbackMessageEl.innerText = feedbackMessage;
            explanationTextEl.innerText = currentQuiz.explanation;
            
            setTimeout(() => {
                feedbackModal.classList.remove('hidden');
            }, 500);
        }

        function showResults() {
            saveGameState();
            resultContainer.classList.remove('hidden');
            quizContainer.classList.add('hidden');
            
            if (isTimeAttackMode) {
                resultTitle.innerText = "íƒ€ì„ì–´íƒ ì¢…ë£Œ!";
                resultMessage.innerHTML = `60ì´ˆ ë™ì•ˆ ì´ <span class="font-bold text-blue-500">${score}</span>ê°œì˜ ë¬¸ì œë¥¼ ë§í˜”ìŠµë‹ˆë‹¤!`;
                restartBtn.classList.add('hidden');
                reviewExplanationsBtn.classList.remove('hidden');
            } else {
                resultTitle.innerText = "í€´ì¦ˆ ì™„ë£Œ!";
                resultMessage.innerHTML = `ì´ <span id="total-questions" class="font-bold">${currentQuizData.length}</span>ë¬¸ì œ ì¤‘ <span id="score" class="font-bold text-blue-500">${score}</span>ê°œë¥¼ ë§íˆì…¨ìŠµë‹ˆë‹¤!`;
                restartBtn.classList.remove('hidden');
                reviewExplanationsBtn.classList.add('hidden');
            }
        }
        
        // --- íƒ€ì„ì–´íƒ ê´€ë ¨ í•¨ìˆ˜ë“¤ ---

        function startTimer(duration) {
            stopTimer(); // ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆë‹¤ë©´ í™•ì‹¤íˆ ì¤‘ì§€

            timeLeft = duration;
            timerDisplay.classList.remove('hidden');

            const updateDisplay = () => {
                const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0');
                const seconds = String(timeLeft % 60).padStart(2, '0');
                timerDisplay.innerText = `${minutes}:${seconds}`;
            };

            updateDisplay(); // ì¦‰ì‹œ ì²« ì‹œê°„ í‘œì‹œ

            timeAttackTimer = setInterval(() => {
                timeLeft--;
                updateDisplay();
                if (timeLeft <= 0) {
                    endTimeAttack();
                }
            }, 1000);
        }

        function stopTimer() {
            if (timeAttackTimer) {
                clearInterval(timeAttackTimer);
                timeAttackTimer = null;
            }
        }


        async function loadAllQuizzes() {
            if (allQuizzes.length > 0) return; // ì´ë¯¸ ë¡œë“œë˜ì—ˆìœ¼ë©´ ì‹¤í–‰ ì•ˆ í•¨
            loadingSpinner.classList.remove('hidden');
            try {
                const quizPromises = Object.values(quizInfo).map(info => fetch(info.file).then(res => res.json()));
                const allQuizData = await Promise.all(quizPromises);
                // ì±•í„° êµ¬ì¡°ì—ì„œ ëª¨ë“  ë¬¸ì œë¥¼ í‰íƒ„í™”
                allQuizzes = allQuizData.flatMap(themeArr =>
                    Array.isArray(themeArr)
                        ? themeArr.flatMap(ch => Array.isArray(ch.quizzes) ? ch.quizzes : [])
                        : []
                );
            } catch (error) {
                console.error("ì „ì²´ í€´ì¦ˆ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        async function startTimeAttack() {
            loadingSpinner.classList.remove('hidden');
            try {
                const allQuizzes = await getAllFlatQuizzes();
                if (allQuizzes.length === 0) {
                    alert("í€´ì¦ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    loadingSpinner.classList.add('hidden');
                    return;
                }
                isTimeAttackMode = true;
                currentQuizData = shuffleArray([...allQuizzes]);
                currentQuizIndex = 0;
                score = 0;
                timeAttackSolvedQuizzes = [];

                progressContainer.classList.add('hidden');
                quizThemeTitle.innerText = "íƒ€ì„ì–´íƒ â±ï¸";

                loadQuiz();
                showScreen('quiz-screen');
                resultContainer.classList.add('hidden');
                
                startTimer(60); // 60ì´ˆ íƒ€ì´ë¨¸ ì‹œì‘
            } catch (error) {
                console.error("íƒ€ì„ì–´íƒ í€´ì¦ˆ ë¡œë”© ì‹¤íŒ¨:", error);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        function endTimeAttack() {
            stopTimer();
            showResults();
        }

        function startExplanationReview() {
            reviewIndex = 0;
            if (timeAttackSolvedQuizzes.length === 0) {
                feedbackModal.classList.add('hidden');
                showScreen('main-screen');
                return;
            }
            showReviewModal();
        }

        function showReviewModal() {
            const quiz = timeAttackSolvedQuizzes[reviewIndex];
            const currentPet = petInfo[gameState.settings.selectedPet] || petInfo.cat;

            feedbackPetIcon.innerText = currentPet.icon;
            feedbackMessageEl.innerText = `[${reviewIndex + 1}/${timeAttackSolvedQuizzes.length}] ${quiz.question}`;
            explanationTextEl.innerText = quiz.explanation;
            explanationContainer.classList.remove('bg-green-100', 'dark:bg-green-900', 'bg-red-100', 'dark:bg-red-900');
            
            if (reviewIndex === timeAttackSolvedQuizzes.length - 1) {
                nextBtn.innerText = "ë©”ì¸ìœ¼ë¡œ";
            } else {
                nextBtn.innerText = "ë‹¤ìŒ";
            }
            feedbackModal.classList.remove('hidden');
        }


        function showNotes() {
            const retryBtn = document.getElementById('retry-notes-btn');
            if (incorrectQuizzes.length === 0) {
                notesContent.innerHTML = '<p class="text-center">ì•„ì§ í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. í›Œë¥­í•´ìš”!</p>';
                retryBtn.disabled = true;
            } else {
                notesContent.innerHTML = incorrectQuizzes.map((q, index) => `
                    <div class="relative mb-2 p-3 bg-slate-50 dark:bg-slate-700 rounded group">
                        <p class="font-bold pr-8">${index + 1}. ${q.question}</p>
                        <p class="text-sm text-green-600">ì •ë‹µ: ${q.answer}</p>
                        <button class="delete-note-btn absolute top-1/2 right-2 -translate-y-1/2 text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition" data-index="${index}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </button>
                    </div>
                `).join('');
                retryBtn.disabled = false;
            }
        }
        
        function populatePetSelection() {
            const container = document.getElementById('pet-selection-container');
            container.innerHTML = '';
            for (const key in petInfo) {
                const pet = petInfo[key];
                const isSelected = gameState.settings.selectedPet === key;
                const element = document.createElement('div');
                element.className = `p-4 rounded-lg flex items-center border-2 ${isSelected ? 'border-blue-500' : 'border-custom'}`;
                element.innerHTML = `
                    <div class="text-4xl mr-4">${pet.icon}</div>
                    <div class="text-left flex-1">
                        <div class="font-bold">${pet.name}</div>
                        <div class="text-sm subtext">${pet.description}</div>
                    </div>
                    <button data-pet-key="${key}" class="select-pet-btn ml-4 px-4 py-2 rounded-lg text-sm font-bold ${isSelected ? 'bg-gray-400 text-white cursor-not-allowed' : 'bg-blue-500 text-white hover:bg-blue-600'}">${isSelected ? 'ì„ íƒë¨' : 'ì„ íƒ'}</button>
                `;
                container.appendChild(element);
            }
        }

// 2. ì±•í„° ì„ íƒ UI í•¨ìˆ˜
async function showChapterSelect(themeKey) {
    loadingSpinner.classList.remove('hidden');
    try {
        const response = await fetch(quizInfo[themeKey].file);
        const chapters = await response.json(); // [{chapter, quizzes: [...]}, ...]
        const chapterModal = document.getElementById('chapter-modal');
        const chapterList = document.getElementById('chapter-list');
        chapterList.innerHTML = '';
        chapters.forEach((ch, idx) => {
            const btn = document.createElement('button');
            btn.className = 'w-full bg-slate-200 rounded-lg p-4 mb-2 font-bold hover:bg-slate-300';
            btn.innerText = ch.chapter;
            btn.addEventListener('click', () => {
                chapterModal.classList.add('hidden');
                startQuizWithChapter(ch.quizzes, themeKey, ch.chapter);
            });
            chapterList.appendChild(btn);
        });
        chapterModal.classList.remove('hidden');
    } catch (e) {
        alert('ì±•í„° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    } finally {
        loadingSpinner.classList.add('hidden');
    }
}

// 3. ì±•í„°ë³„ í€´ì¦ˆ ì‹œì‘ í•¨ìˆ˜
function startQuizWithChapter(quizArr, themeKey, chapterName) {
    isReviewMode = false;
    isTimeAttackMode = false;
    currentQuizData = quizArr;
    currentQuizIndex = 0;
    score = 0;
    quizThemeTitle.innerText = `${quizInfo[themeKey].title} - ${chapterName}`;
    quizThemeTitle.dataset.themeKey = themeKey;
    progressContainer.classList.remove('hidden');
    timerDisplay.classList.add('hidden');
    loadQuiz();
    showScreen('quiz-screen');
    resultContainer.classList.add('hidden');
    quizContainer.classList.remove('hidden');
}

// 4. í…Œë§ˆ ë²„íŠ¼ í´ë¦­ ì‹œ ì±•í„° ì„ íƒìœ¼ë¡œ ì—°ê²°
document.querySelectorAll('.theme-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const themeKey = btn.dataset.theme;
        if (quizInfo[themeKey]) {
            document.getElementById('theme-modal').classList.add('hidden');
            showChapterSelect(themeKey);
        }
    });
});

        document.addEventListener('DOMContentLoaded', () => {
            loadGameState();
            applySettings();
            checkAttendance();
            updateMainUI();
            loadAllQuizzes(); // ì•± ì‹œì‘ ì‹œ ëª¨ë“  í€´ì¦ˆ ë¯¸ë¦¬ ë¡œë“œ

            document.querySelectorAll('.main-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if(gameState.settings.soundEnabled) clickSound.triggerAttackRelease("C4", "0.1");
                    if (!isBgmInitialized) {
                        manageBgm();
                        isBgmInitialized = true;
                    }
                });
            });

            document.getElementById('theme-select-btn').addEventListener('click', () => document.getElementById('theme-modal').classList.remove('hidden'));
            document.getElementById('notes-btn').addEventListener('click', () => { showNotes(); document.getElementById('notes-modal').classList.remove('hidden'); });
            document.getElementById('settings-btn').addEventListener('click', () => document.getElementById('settings-modal').classList.remove('hidden'));
            document.getElementById('pet-select-btn').addEventListener('click', () => {
                populatePetSelection();
                document.getElementById('pet-modal').classList.remove('hidden');
            });
            document.getElementById('daily-quiz-btn').addEventListener('click', () => startDailyQuiz());
            document.getElementById('time-attack-btn').addEventListener('click', async () => {
    if (typeof Tone !== "undefined" && Tone.context && Tone.context.state !== "running") {
        await Tone.start();
    }
    startTimeAttack();
});
            reviewExplanationsBtn.addEventListener('click', startExplanationReview); // í•´ì„¤ ë³´ê¸° ì‹œì‘

            document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', () => btn.closest('.fixed').classList.add('hidden')));
            window.addEventListener('click', (e) => { if (e.target.classList.contains('fixed')) e.target.classList.add('hidden'); });

            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const themeKey = btn.dataset.theme;
                    if (quizInfo[themeKey]) {
                        document.getElementById('theme-modal').classList.add('hidden');
                        showChapterSelect(themeKey);
                    }
                });
            });
            
            document.getElementById('pet-selection-container').addEventListener('click', (e) => {
                const target = e.target.closest('.select-pet-btn');
                if (target && !target.disabled) {
                    const petKey = target.dataset.petKey;
                    gameState.settings.selectedPet = petKey;
                    saveGameState();
                    updateMainUI();
                    populatePetSelection();
                }
            });

            document.getElementById('retry-notes-btn').addEventListener('click', () => {
                const reviewQuizzes = shuffleArray([...incorrectQuizzes]).slice(0, 10);
                if (reviewQuizzes.length > 0) {
                    document.getElementById('notes-modal').classList.add('hidden');
                    startQuiz('review', reviewQuizzes);
                }
            });

            nextBtn.addEventListener('click', () => {
                // íƒ€ì„ì–´íƒ í•´ì„¤ ë¦¬ë·° ëª¨ë“œì™€ ì¼ë°˜ í€´ì¦ˆ ëª¨ë“œ ë¶„ê¸° ì²˜ë¦¬
                if (isTimeAttackMode) {
                    reviewIndex++;
                    if (reviewIndex < timeAttackSolvedQuizzes.length) {
                        showReviewModal();
                    } else {
                        feedbackModal.classList.add('hidden');
                        showScreen('main-screen');
                    }
                } else { // ì¼ë°˜ í€´ì¦ˆ ëª¨ë“œ
                    feedbackModal.classList.add('hidden');
                    currentQuizIndex++;
                    if (currentQuizIndex < currentQuizData.length) {
                        loadQuiz();
                    } else {
                        showResults();
                    }
                }
            });

            restartBtn.addEventListener('click', () => {
                const themeKey = quizThemeTitle.dataset.themeKey;
                if (themeKey === 'review' || themeKey === 'daily') {
                    showScreen('main-screen');
                } else {
                    startQuiz(themeKey);
                }
            });

            homeBtn.addEventListener('click', () => {
                stopTimer(); // í™ˆìœ¼ë¡œ ê°ˆ ë•Œ íƒ€ì´ë¨¸ ì¤‘ì§€
                isTimeAttackMode = false;
                showScreen('main-screen');
            });

            notesContent.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-note-btn');
                if (deleteBtn) {
                    const indexToRemove = parseInt(deleteBtn.dataset.index, 10);
                    incorrectQuizzes.splice(indexToRemove, 1);
                    showNotes();
                }
            });

            const darkModeToggle = document.getElementById('dark-mode-toggle');
            darkModeToggle.addEventListener('change', () => {
                gameState.settings.darkMode = darkModeToggle.checked;
                saveGameState();
                applySettings();
            });
            
            const soundToggle = document.getElementById('sound-toggle');
            soundToggle.addEventListener('change', () => {
                gameState.settings.soundEnabled = soundToggle.checked;
                saveGameState();
            });

            const bgmToggle = document.getElementById('bgm-toggle');
            bgmToggle.addEventListener('change', () => {
                gameState.settings.bgmEnabled = bgmToggle.checked;
                saveGameState();
                manageBgm();
            });

            const fontSizeControls = document.getElementById('font-size-controls');
            fontSizeControls.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const size = e.target.dataset.size;
                    gameState.settings.fontSize = size;
                    saveGameState();
                    applySettings();
                }
            });

            /*
            // ì»¤í”¼ ì‚¬ì£¼ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²° (ì„ì‹œ ë¹„í™œì„±í™”)
            const coffeeBtn = document.getElementById('coffee-btn');
            if (coffeeBtn) {
                coffeeBtn.addEventListener('click', () => {
                    window.open('https://buymeacoffee.com/mosi1865', '_blank');
                });
            }
            */
        });
    </script>
</body>
</html>
